<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard - Kim's Food Hub</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='admin_styles.css') }}">
</head>
<body>
  {% include 'navbar.html' %}

  <div class="dashboard-container">
    <div class="main-content">
      <section class="hero">
        <div class="hero-content">
          <h1>Admin Dashboard</h1>
          <p>Monitor users and system activity.</p>
        </div>
      </section>

      <section class="stats" style="padding: 60px 40px; background-color: #f9f9f9;">
        <h2>System Statistics</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <h3>Total Users</h3>
            <p>{{ total_users }}</p>
          </div>
          <div class="stat-card">
            <h3>Total Orders</h3>
            <p>{{ total_orders }}</p>
          </div>
          <div class="stat-card">
            <h3>Total Revenue</h3>
            <p>₱{{ "%.2f"|format(total_revenue) }}</p>
          </div>
        </div>
      </section>



      <section class="all-orders" style="padding: 60px 40px;">
        <h2>All Orders</h2>
        <table id="all-orders-table" class="orders-table">
          <thead>
            <tr>
              <th>User Name</th>
              <th>Email</th>
              <th>Phone</th>
              <th>Address</th>
              <th>Postal</th>
              <th>City</th>
              <th>Date</th>
              <th>Items</th>
              <th>Total</th>
              <th>Payment Method</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for order in all_orders %}
            <tr>
              <td>{{ order.user_name }}</td>
              <td>{{ order.user_email }}</td>
              <td>{{ order.phone }}</td>
              <td>{{ order.address }}</td>
              <td>{{ order.postal }}</td>
              <td>{{ order.city }}</td>
              <td>{{ order.date }}</td>
              <td>{{ order['items'] | join(', ') }}</td>
              <td>₱{{ "%.2f"|format(order.total) }}</td>
              <td>{{ order.payment_method }}</td>
              <td>{{ order.status }}</td>
              <td class="actions-cell">
                <div class="button-container">
                  <a href="{{ url_for('edit_order', order_id=order.order_id) }}" class="btn btn-primary">Edit</a>
                  <button type="button" class="btn btn-danger" onclick="removeOrder('{{ order.order_id }}')">Remove Order</button>
                  {% if order.status != 'Cancelled' %}
                  <button type="button" class="btn btn-warning" onclick="cancelOrder('{{ order.order_id }}')">Cancel Order</button>
                  {% endif %}
                  {% if order.status == 'Processing' %}
                  <button type="button" class="btn btn-success" onclick="approveOrder('{{ order.order_id }}')">Approve Order</button>
                  {% elif order.status == 'Paid' %}
                  <button type="button" class="btn btn-info" onclick="updateStatus('{{ order.order_id }}', 'Preparing')">Start Preparing</button>
                  {% elif order.status == 'Preparing' %}
                  <button type="button" class="btn btn-info" onclick="updateStatus('{{ order.order_id }}', 'Cooking')">Start Cooking</button>
                  {% elif order.status == 'Cooking' %}
                  <button type="button" class="btn btn-info" onclick="updateStatus('{{ order.order_id }}', 'On the way')">Out for Delivery</button>
                  {% elif order.status == 'On the way' %}
                  <button type="button" class="btn btn-info" onclick="updateStatus('{{ order.order_id }}', 'Delivered')">Mark Delivered</button>
                  {% elif order.status == 'Delivered' %}
                  <span class="status-delivered">Delivered</span>
                  {% elif order.status == 'Cancelled' %}
                  <span class="status-cancelled">Cancelled</span>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </section>

      <section class="users-table" style="padding: 60px 40px;">
        <h2>All Users</h2>
        <table id="all-users-table" class="orders-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Phone</th>
              <th>Role</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for user in users if user.role != 'admin' %}
            <tr>
              <td>{{ user.name }}</td>
              <td>{{ user.email }}</td>
              <td>{{ user.phone }}</td>
              <td>{{ user.role }}</td>
              <td class="actions-cell">
                <div class="button-container">
                  <button type="button" class="btn btn-danger" onclick="removeUser('{{ user.email }}')">Remove User</button>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </section>

      <section class="orders-per-user" style="padding: 60px 40px;">
        <h2>Orders Per User</h2>
        <table id="orders-per-user-table" class="orders-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Phone</th>
              <th>Role</th>
              <th>Number of Orders</th>
            </tr>
          </thead>
          <tbody>
            {% for user in users if user.role != 'admin' %}
            <tr>
              <td>{{ user.name }}</td>
              <td>{{ user.email }}</td>
              <td>{{ user.phone }}</td>
              <td>{{ user.role }}</td>
              <td>{{ orders_per_user.get(user.email, 0) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </section>

      <section class="manage-reviews" style="padding: 60px 40px;">
        <h2>Manage Reviews</h2>
        <table id="reviews-table" class="orders-table">
          <thead>
            <tr>
              <th>Order ID</th>
              <th>User Email</th>
              <th>Rating</th>
              <th>Comment</th>
              <th>Status</th>
              <th>Date and Time</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="reviews-tbody">

          </tbody>
        </table>
      </section>

      <section class="chat-section" style="padding: 60px 40px;">
        <h2>Chat with Users</h2>
        <div id="notifications" class="notifications-container"></div>
        <div class="chat-container">
          <div class="user-list">
            <h3>Users</h3>
            <ul id="user-list">
              {% for user in users if user.role != 'admin' %}
              <li class="user-item" data-email="{{ user.email }}">{{ user.name }} ({{ user.email }})</li>
              {% endfor %}
            </ul>
          </div>
          <div class="chat-window">
            <div id="chat-messages" class="messages"></div>
            <div class="message-input">
              <input type="text" id="message-input" placeholder="Type your message...">
              <button id="send-button">Send</button>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <footer>
    <p>© 2025 Online Food Ordering System. | John 3:16 Unconditional Love.</p>
  </footer>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="{{ url_for('static', filename='script.js') }}"></script>
  <script>
    const socket = io();

    socket.on('order_update', function(data) {
      console.log('Order update received:', data);
      fetchOrders();
    });

    let selectedUser = null;

    document.addEventListener('DOMContentLoaded', function() {
      fetchOrders();
      fetchReviews();
      setInterval(fetchOrders, 5000); 

      document.getElementById('user-list').addEventListener('click', function(e) {
        if (e.target.classList.contains('user-item')) {
          const userEmail = e.target.getAttribute('data-email');
          selectUser(userEmail);
        }
      });

      document.getElementById('send-button').addEventListener('click', sendMessage);
      document.getElementById('message-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          sendMessage();
        }
      });

      socket.on('receive_message', function(data) {
        if (selectedUser === data.sender_email) {
          displayMessage(data.message, 'received', data.timestamp, data.sender_email);
        } else {
          showNotification(`New message from ${data.sender_email}: ${data.message}`, data.sender_email);
        }
      });
    });

    function selectUser(email) {
      selectedUser = email;
      document.querySelectorAll('.user-item').forEach(item => item.classList.remove('selected'));
      document.querySelector(`[data-email="${email}"]`).classList.add('selected');
      loadMessages(email);
    }

    async function loadMessages(userEmail) {
      try {
        const response = await fetch('/get_messages');
        if (response.ok) {
          const data = await response.json();
          const messagesDiv = document.getElementById('chat-messages');
          messagesDiv.innerHTML = '';
          data.messages.forEach(msg => {
            if ((msg.sender_email === userEmail && msg.receiver_email === '{{ user_email }}') ||
                (msg.sender_email === '{{ user_email }}' && msg.receiver_email === userEmail)) {
              const type = msg.sender_email === '{{ user_email }}' ? 'sent' : 'received';
              const sender = type === 'received' ? msg.sender_email : '';
              displayMessage(msg.message, type, msg.timestamp, sender);
            }
          });
        }
      } catch (error) {
        console.error('Error loading messages:', error);
      }
    }

    function displayMessage(message, type, timestamp, sender = '') {
      const messagesDiv = document.getElementById('chat-messages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      const senderText = type === 'received' ? `<strong>${sender}:</strong> ` : '';
      messageDiv.innerHTML = `${senderText}${message} <small>${timestamp}</small>`;
      messagesDiv.appendChild(messageDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    async function sendMessage() {
      const input = document.getElementById('message-input');
      const message = input.value.trim();
      if (!selectedUser) {
        alert('Please select a user to send the message to.');
        return;
      }
      if (!message) return;

      try {
        const response = await fetch('/send_message', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            receiver_email: selectedUser,
            message: message
          })
        });
        if (response.ok) {
          displayMessage(message, 'sent', new Date().toLocaleString());
          input.value = '';
        } else {
          alert('Failed to send message');
        }
      } catch (error) {
        console.error('Error sending message:', error);
        alert('Error sending message');
      }
    }
  
    async function fetchOrders() {
      try {
        const response = await fetch('/api/orders');
        if (response.ok) {
          const data = await response.json();
          updateOrdersTable(data.orders);
          updateUsersTable(data.users);
          updateStats(data.total_users, data.total_orders, data.total_revenue);
          updateOrdersPerUser(data.orders, data.users);
        } else {
          console.error('Failed to fetch orders:', response.status);
        }
      } catch (error) {
        console.error('Error fetching orders:', error);
      }
    }

    function updateOrdersTable(orders) {
      const tbody = document.querySelector('#all-orders-table tbody');
      tbody.innerHTML = '';
      orders.forEach((order) => {
        let actionButtons = `<a href="/edit_order/${order.order_id}" class="btn btn-primary">Edit</a>`;
        actionButtons += `<button type="button" class="btn btn-danger" onclick="removeOrder('${order.order_id}')">Remove Order</button>`;
        if (order.status !== 'Cancelled') {
          actionButtons += `<button type="button" class="btn btn-warning" onclick="cancelOrder('${order.order_id}')">Cancel Order</button>`;
        }
        if (order.status === 'Processing') {
          actionButtons += `<button type="button" class="btn btn-success" onclick="approveOrder('${order.order_id}')">Approve Order</button>`;
        } else if (order.status === 'Paid') {
          actionButtons += `<button type="button" class="btn btn-info" onclick="updateStatus('${order.order_id}', 'Preparing')">Start Preparing</button>`;
        } else if (order.status === 'Preparing') {
          actionButtons += `<button type="button" class="btn btn-info" onclick="updateStatus('${order.order_id}', 'Cooking')">Start Cooking</button>`;
        } else if (order.status === 'Cooking') {
          actionButtons += `<button type="button" class="btn btn-info" onclick="updateStatus('${order.order_id}', 'On the way')">Out for Delivery</button>`;
        } else if (order.status === 'On the way') {
          actionButtons += `<button type="button" class="btn btn-info" onclick="updateStatus('${order.order_id}', 'Delivered')">Mark Delivered</button>`;
        } else if (order.status === 'Delivered') {
          actionButtons += '<button type="button" class="btn btn-success">Delivered</button>';
        } else if (order.status === 'Cancelled') {
          actionButtons += '<span class="status-cancelled">Cancelled</span>';
        }

        const localDate = new Date(order.date).toLocaleString();
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${order.user_name}</td>
          <td>${order.user_email}</td>
          <td>${order.phone}</td>
          <td>${order.address}</td>
          <td>${order.postal}</td>
          <td>${order.city}</td>
          <td>${localDate}</td>
          <td>${order.items.join(', ')}</td>
          <td>₱${order.total.toFixed(2)}</td>
          <td>${order.payment_method}</td>
          <td>${order.status}</td>
          <td class="actions-cell">
            <div class="button-container">
              ${actionButtons}
            </div>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function updateUsersTable(users) {
      const tbody = document.querySelector('#all-users-table tbody');
      tbody.innerHTML = '';
      const currentUserEmail = '{{ user_email }}'; 
      users.forEach((user) => {
        if (user.role !== 'admin') {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${user.name}</td>
            <td>${user.email}</td>
            <td>${user.phone}</td>
            <td>${user.role}</td>
            <td class="actions-cell">
              <div class="button-container">
                <button type="button" class="btn btn-danger" onclick="removeUser('${user.email}')">Remove User</button>
              </div>
            </td>
          `;
          tbody.appendChild(row);
        }
      });
    }

    function updateStats(totalUsers, totalOrders, totalRevenue) {
      document.querySelector('.stat-card:nth-child(1) p').textContent = totalUsers;
      document.querySelector('.stat-card:nth-child(2) p').textContent = totalOrders;
      document.querySelector('.stat-card:nth-child(3) p').textContent = '₱' + totalRevenue.toFixed(2);
    }

    function updateOrdersPerUser(orders, users) {
      const ordersPerUser = {};
      orders.forEach(order => {
        const email = order.user_email;
        if (!ordersPerUser[email]) {
          ordersPerUser[email] = 0;
        }
        ordersPerUser[email]++;
      });
      const tbody = document.querySelector('#orders-per-user-table tbody');
      tbody.innerHTML = '';
      users.forEach((user) => {
        if (user.role !== 'admin') {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${user.name}</td>
            <td>${user.email}</td>
            <td>${user.phone}</td>
            <td>${user.role}</td>
            <td>${ordersPerUser[user.email] || 0}</td>
          `;
          tbody.appendChild(row);
        }
      });
    }

    async function approveOrder(orderId) {
      try {
        const response = await fetch(`/approve_order/${orderId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
        });
        if (response.ok) {
          fetchOrders(); 
        } else {
          alert('Failed to approve order');
        }
      } catch (error) {
        console.error('Error approving order:', error);
        alert('Error approving order');
      }
    }

    async function cancelOrder(orderId) {
      if (confirm('Are you sure you want to cancel this order?')) {
        try {
          const response = await fetch(`/cancel_order/${orderId}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
            },
          });
          if (response.ok) {
            fetchOrders(); 
          } else {
            alert('Failed to cancel order');
          }
        } catch (error) {
          console.error('Error cancelling order:', error);
          alert('Error cancelling order');
        }
      }
    }

    async function updateStatus(orderId, status) {
      try {
        const response = await fetch(`/update_order_status/${orderId}/${status}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
        });
        if (response.ok) {
          fetchOrders(); 
        } else {
          alert('Failed to update order status');
        }
      } catch (error) {
        console.error('Error updating order status:', error);
        alert('Error updating order status');
      }
    }

    async function removeUser(email) {
      if (confirm('Are you sure you want to remove this user?')) {
        try {
          const response = await fetch(`/remove_user/${email}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
            },
          });
          if (response.ok) {
            fetchOrders();
            alert('User removed successfully');
          } else {
            alert('Failed to remove user');
          }
        } catch (error) {
          console.error('Error removing user:', error);
          alert('Error removing user');
        }
      }
    }

    async function removeOrder(orderId) {
      if (confirm('Are you sure you want to remove this order?')) {
        try {
          const response = await fetch(`/remove_order/${orderId}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
            },
          });
          if (response.ok) {
            fetchOrders();
            alert('Order removed successfully');
          } else {
            alert('Failed to remove order');
          }
        } catch (error) {
          console.error('Error removing order:', error);
          alert('Error removing order');
        }
      }
    }

    function showNotification(message, senderEmail) {
      const notificationsDiv = document.getElementById('notifications');
      const notificationDiv = document.createElement('div');
      notificationDiv.className = 'notification';
      notificationDiv.innerHTML = `<span>${message}</span><button class="close-notification">&times;</button>`;
      notificationsDiv.appendChild(notificationDiv);

      notificationDiv.addEventListener('click', () => {
        selectUser(senderEmail);
        notificationDiv.remove(); 
      });

      setTimeout(() => {
        if (notificationDiv.parentNode) {
          notificationDiv.remove();
        }
      }, 10000);

      notificationDiv.querySelector('.close-notification').addEventListener('click', (e) => {
        e.stopPropagation();
        notificationDiv.remove();
      });
    }

    async function fetchReviews() {
      try {
        const response = await fetch('/api/reviews');
        if (response.ok) {
          const data = await response.json();
          updateReviewsTable(data.reviews);
        } else {
          console.error('Failed to fetch reviews:', response.status);
        }
      } catch (error) {
        console.error('Error fetching reviews:', error);
      }
    }

    function updateReviewsTable(reviews) {
      const tbody = document.getElementById('reviews-tbody');
      tbody.innerHTML = '';
      reviews.forEach((review) => {
        const status = review.approved ? 'Approved' : 'Pending';
        const actions = review.approved
          ? `<button type="button" class="btn btn-danger" onclick="deleteReview('${review.id}')">Delete</button>`
          : `<button type="button" class="btn btn-success" onclick="approveReview('${review.id}')">Approve</button> <button type="button" class="btn btn-danger" onclick="deleteReview('${review.id}')">Delete</button>`;

        const timestamp = new Date(review.timestamp).toLocaleString();
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${review.order_id}</td>
          <td>${review.user_email}</td>
          <td class="admin-rating">${Array.from({length: 5}, (_, i) => `<span class="star ${i < review.rating ? 'active' : ''}">★</span>`).join('')}</td>
          <td>${review.comment}</td>
          <td>${status}</td>
          <td>${timestamp}</td>
          <td class="actions-cell">
            <div class="button-container">
              ${actions}
            </div>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    async function approveReview(reviewId) {
      if (confirm('Are you sure you want to approve this review?')) {
        try {
          const response = await fetch(`/approve_review/${reviewId}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
            },
          });
          if (response.ok) {
            fetchReviews(); 
            alert('Review approved successfully');
          } else {
            alert('Failed to approve review');
          }
        } catch (error) {
          console.error('Error approving review:', error);
          alert('Error approving review');
        }
      }
    }

    async function deleteReview(reviewId) {
      if (confirm('Are you sure you want to delete this review?')) {
        try {
          const response = await fetch(`/delete_review/${reviewId}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
            },
          });
          if (response.ok) {
            fetchReviews(); // Refresh the reviews
            alert('Review deleted successfully');
          } else {
            alert('Failed to delete review');
          }
        } catch (error) {
          console.error('Error deleting review:', error);
          alert('Error deleting review');
        }
      }
    }

  </script>
</body>
</html>
